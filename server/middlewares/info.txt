here the code of the middleware 